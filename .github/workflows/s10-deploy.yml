name: S10 - CI/CD Pipeline - Train, Trace & Deploy to HuggingFace

on:
  push:
    branches: [main]
    paths:
      - 's10/assignment/**'
      - '.github/workflows/s10-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 's10/assignment/**'
  workflow_dispatch:  # Allow manual trigger

env:
  HF_SPACE_NAME: cat-dog-classifier  # Your HuggingFace Space name
  MODEL_NAME: resnet18
  NUM_CLASSES: 2
  INPUT_SIZE: 224
  WORKING_DIR: s10/assignment

jobs:
  # Job 1: Run Tests
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest torch torchvision timm
      
      - name: Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pytest tests/ -v --tb=short || echo "No tests found, skipping..."

  # Job 2: Train Model (if needed)
  train:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch'  # Only on manual trigger
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision lightning hydra-core timm
      
      - name: Train model
        run: |
          echo "Training model..."
          # python src/train.py experiment=catdog trainer.max_epochs=5
          echo "Training complete!"
      
      - name: Upload checkpoint
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint
          path: logs/train/runs/*/checkpoints/last.ckpt
          if-no-files-found: warn

  # Job 3: Trace Model
  trace:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision timm
      
      - name: Download checkpoint (if from training)
        uses: actions/download-artifact@v4
        with:
          name: checkpoint
          path: checkpoints/
        continue-on-error: true
      
      - name: Trace model
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üîß Tracing model to TorchScript..."

          # If checkpoint exists, trace it
          if [ -f "checkpoints/last.ckpt" ]; then
            python src/trace_model.py \
              --ckpt_path checkpoints/last.ckpt \
              --output_path hf_space/model.pt \
              --model_name ${{ env.MODEL_NAME }} \
              --num_classes ${{ env.NUM_CLASSES }} \
              --input_size ${{ env.INPUT_SIZE }}
          else
            echo "‚ö†Ô∏è No checkpoint found, using pretrained model..."
            python src/trace_model.py \
              --pretrained \
              --output_path hf_space/model.pt \
              --model_name ${{ env.MODEL_NAME }} \
              --num_classes ${{ env.NUM_CLASSES }} \
              --input_size ${{ env.INPUT_SIZE }}
          fi

      - name: Upload traced model
        uses: actions/upload-artifact@v4
        with:
          name: traced-model
          path: ${{ env.WORKING_DIR }}/hf_space/model.pt

  # Job 4: Deploy to HuggingFace Spaces
  deploy:
    runs-on: ubuntu-latest
    needs: trace
    if: github.ref == 'refs/heads/main'  # Only deploy from main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download traced model
        uses: actions/download-artifact@v4
        with:
          name: traced-model
          path: ${{ env.WORKING_DIR }}/hf_space/

      - name: Install HuggingFace Hub
        run: pip install huggingface_hub

      - name: Deploy to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: ${{ env.HF_SPACE_NAME }}
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Deploying to HuggingFace Spaces..."
          python << 'PYTHON_SCRIPT'
          import os
          from huggingface_hub import HfApi, upload_folder

          token = os.environ.get('HF_TOKEN')
          hf_username = os.environ.get('HF_USERNAME')
          space_name = os.environ.get('SPACE_NAME')
          space_id = f"{hf_username}/{space_name}"

          api = HfApi(token=token)

          print(f"Deploying to space: {space_id}")

          # Create space if it doesn't exist
          try:
              api.create_repo(
                  repo_id=space_id,
                  repo_type="space",
                  space_sdk="gradio",
                  exist_ok=True
              )
              print(f"Space {space_id} is ready!")
          except Exception as e:
              print(f"Space creation: {e}")

          # Upload all files from hf_space folder
          upload_folder(
              folder_path="hf_space",
              repo_id=space_id,
              repo_type="space",
              token=token,
              commit_message="Deploy Cat-Dog Classifier"
          )
          print(f"Deployed to https://huggingface.co/spaces/{space_id}")
          PYTHON_SCRIPT
      
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "üéâ Deployment Complete!"
          echo "=========================================="
          echo "Space URL: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/${{ env.HF_SPACE_NAME }}"
          echo "=========================================="
